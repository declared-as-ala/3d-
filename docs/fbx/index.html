<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- HTML Meta Tags -->
    <title>KalidoKit - FBX Mode</title>
    <meta
      name="description"
      content="Track face and body rigs with FBX models!"
    />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta property="twitter:domain" content="kit.kalidoface.com" />
    <meta property="twitter:url" content="https://kit.kalidoface.com/fbx/" />
    <meta name="twitter:title" content="KalidoKit - FBX Mode" />
    <meta
      name="twitter:description"
      content="Track face and body rigs with FBX models!"
    />
    <meta
      name="viewport"
      content="viewport-fit=cover, user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link
      rel="shortcut icon"
      href="https://yeemachine.github.io/kalidoface-live2d-models/Icons/icon-circle.svg"
    />
    <!--     Basic Three.js -->
    <script src="https://unpkg.com/three@0.133.0/build/three.js"></script>
    <!--     GLTF Loader for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/loaders/GLTFLoader.js"></script>
    <!--     fflate library (required for FBX binary files) -->
    <!-- Use UMD version that properly exposes fflate globally -->
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.4/umd/index.js"></script>
    <script>
      // UMD version should expose fflate globally, but we verify and ensure it's available
      (function() {
        function checkFflate() {
          // UMD should expose it as window.fflate or just fflate
          if (typeof window !== 'undefined' && window.fflate) {
            console.log('✓ fflate available via window.fflate');
            return true;
          }
          if (typeof fflate !== 'undefined') {
            // Ensure it's in window for FBXLoader
            if (typeof window !== 'undefined') {
              window.fflate = fflate;
            }
            console.log('✓ fflate found and exposed to window');
            return true;
          }
          return false;
        }
        
        // Check immediately
        if (checkFflate()) {
          console.log('✓ fflate is ready');
        } else {
          // Wait a bit for UMD to load
          var attempts = 0;
          var maxAttempts = 20; // 1 second
          var interval = setInterval(function() {
            attempts++;
            if (checkFflate()) {
              clearInterval(interval);
              console.log('✓ fflate loaded after ' + (attempts * 50) + 'ms');
            } else if (attempts >= maxAttempts) {
              clearInterval(interval);
              console.error('✗ fflate failed to load after ' + (maxAttempts * 50) + 'ms');
            }
          }, 50);
        }
      })();
    </script>
    <!--     FBX Loader dependencies (required for FBXLoader) -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/libs/inflate.min.js"></script>
    <!--     FBX Loader for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/loaders/FBXLoader.js"></script>
    <!--     Orbit Controls for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/controls/OrbitControls.js"></script>
    <!--     Kalidokit Library (UMD build for compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/kalidokit@1.1/dist/kalidokit.umd.js"></script>
    <!--     Mediapipe or Tensorflow.js -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic@0.5.1635989137/holistic.js"
      crossorigin="anonymous"
    ></script>

    <!--     Mediapipe Drawing Tools -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <!--     Mediapipe Camera Tools -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <div class="preview">
      <video class="input_video" width="1280px" height="720px"></video>
      <canvas class="guides"></canvas>
      <section>
        <a href="/live2d/"><p>Live2D</p></a>
        <a href="/"><p>VRM</p></a>
        <a class="current" href="/fbx/"><p>FBX</p></a>
      </section>
    </div>
    <div class="upload-container">
      <button id="run-animation" class="upload-button" style="display: none;">Run</button>
      <button id="tracking-toggle" class="upload-button" style="margin-left: 10px;">Start Tracking</button>
    </div>
    <p class="credit">Made by Ala Missaoui</p>
    <script src="./script.js" defer></script>
  </body>
</html>

